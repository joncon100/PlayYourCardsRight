<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Card Sequence</title>

<style>
  :root{
    --cardW: 90px;
    --cardH: 126px;
    --gap: 14px;

    --flipDur: 600ms;
    --moveDur: 650ms;
    --liftDur: 180ms;
    --liftPx: 18px;
  }

  html, body { height:100%; }

  body{
    margin:0;
    background: transparent;
    display:flex;
    justify-content:center;
    align-items:center;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }

  .wrap{ padding:12px; }

  #table{
    display:flex;
    flex-direction:column;
    gap:18px;
    user-select:none;
  }

  .row{ display:flex; gap:var(--gap); }

  .slot{
    width:var(--cardW);
    height:var(--cardH);
    position:relative;
  }

  .scene{
    width:100%;
    height:100%;
    perspective:900px;
    filter: drop-shadow(0 10px 22px rgba(0,0,0,0.35));
    cursor:pointer;
    position:relative;
    will-change: transform;
    border-radius: 10px;
  }

  .scene.moving{
    z-index:999;
    filter: drop-shadow(0 18px 34px rgba(0,0,0,0.55));
  }

  .card{
    width:100%;
    height:100%;
    position:relative;
    transform-style:preserve-3d;
    transform: rotateX(0deg);
    transition: transform var(--flipDur) ease-in-out;
    will-change: transform;
  }

  .face{
    position:absolute;
    inset:0;
    backface-visibility:hidden;
    -webkit-backface-visibility:hidden;
    overflow:hidden;
    border-radius: 10px;
  }

  .face img{
    width:100%;
    height:100%;
    object-fit:contain;
    display:block;
  }

  .back  { transform: rotateX(0deg)   translateZ(0.6px); }
  .front { transform: rotateX(180deg) translateZ(0.6px); }

  .card.is-flipped{ transform: rotateX(180deg); }

  /* ===== Eligible highlight (ONLY when replacement is allowed) ===== */
  .scene.eligible::after{
    content:"";
    position:absolute;
    inset:-6px;
    border-radius: 14px;
    pointer-events:none;
    outline: 3px solid rgba(120, 240, 255, 0.75);
    outline-offset: 3px;
    box-shadow:
      0 0 18px rgba(120, 240, 255, 0.45),
      0 0 40px rgba(120, 240, 255, 0.20);
    animation: pulse 1.2s ease-in-out infinite;
  }

  @keyframes pulse{
    0%,100% { opacity: 0.55; }
    50%     { opacity: 1.00; }
  }

  /* Used replacement state: subtle outline on the SLOT */
  .slot.used-discard::before{
    content:"";
    position:absolute;
    inset:-6px;
    border-radius: 14px;
    pointer-events:none;
    outline: 2px solid rgba(255,255,255,0.35);
    outline-offset: 2px;
    opacity: 0.7;
  }

  @media (prefers-reduced-motion: reduce){
    .card{ transition:none; }
    .scene{ transition:none !important; }
    .scene.eligible::after{ animation:none; }
  }
</style>
</head>

<body>
<div class="wrap">
  <div id="table">

    <!-- Row 3 -->
    <div class="row" id="row3">
      <div class="slot" id="slot-b"></div>

      <div class="slot" id="slot-8">
        <div class="scene" id="s8">
          <div class="card" id="c8">
            <div class="face back"><img src="cardback3.png" alt="Back"></div>
            <div class="face front"><img id="face8" alt="Face 8"></div>
          </div>
        </div>
      </div>

      <div class="slot"></div>
      <div class="slot"></div>
    </div>

    <!-- Row 2 -->
    <div class="row" id="row2">
      <div class="slot" id="slot-a"></div>

      <div class="slot" id="slot-5">
        <div class="scene" id="s5">
          <div class="card" id="c5">
            <div class="face back"><img src="cardback3.png" alt="Back"></div>
            <div class="face front"><img id="face5" alt="Face 5"></div>
          </div>
        </div>
      </div>

      <div class="slot" id="slot-6">
        <div class="scene" id="s6">
          <div class="card" id="c6">
            <div class="face back"><img src="cardback3.png" alt="Back"></div>
            <div class="face front"><img id="face6" alt="Face 6"></div>
          </div>
        </div>
      </div>

      <div class="slot" id="slot-7">
        <div class="scene" id="s7">
          <div class="card" id="c7">
            <div class="face back"><img src="cardback3.png" alt="Back"></div>
            <div class="face front"><img id="face7" alt="Face 7"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 1 -->
    <div class="row" id="row1">
      <div class="slot" id="slot-1">
        <div class="scene" id="s1">
          <div class="card is-flipped" id="c1">
            <div class="face back"><img src="cardback3.png" alt="Back"></div>
            <div class="face front"><img id="face1" alt="Face 1"></div>
          </div>
        </div>
      </div>

      <div class="slot" id="slot-2">
        <div class="scene" id="s2">
          <div class="card" id="c2">
            <div class="face back"><img src="cardback3.png" alt="Back"></div>
            <div class="face front"><img id="face2" alt="Face 2"></div>
          </div>
        </div>
      </div>

      <div class="slot" id="slot-3">
        <div class="scene" id="s3">
          <div class="card" id="c3">
            <div class="face back"><img src="cardback3.png" alt="Back"></div>
            <div class="face front"><img id="face3" alt="Face 3"></div>
          </div>
        </div>
      </div>

      <div class="slot" id="slot-4">
        <div class="scene" id="s4">
          <div class="card" id="c4">
            <div class="face back"><img src="cardback3.png" alt="Back"></div>
            <div class="face front"><img id="face4" alt="Face 4"></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* ====== DECK ====== */
const FACE_IMAGES = [
  "faces/10_of_clubs.png","faces/10_of_diamonds.png","faces/10_of_hearts.png","faces/10_of_spades.png",
  "faces/2_of_clubs.png","faces/2_of_diamonds.png","faces/2_of_hearts.png","faces/2_of_spades.png",
  "faces/3_of_clubs.png","faces/3_of_diamonds.png","faces/3_of_hearts.png","faces/3_of_spades.png",
  "faces/4_of_clubs.png","faces/4_of_diamonds.png","faces/4_of_hearts.png","faces/4_of_spades.png",
  "faces/5_of_clubs.png","faces/5_of_diamonds.png","faces/5_of_hearts.png","faces/5_of_spades.png",
  "faces/6_of_clubs.png","faces/6_of_diamonds.png","faces/6_of_hearts.png","faces/6_of_spades.png",
  "faces/7_of_clubs.png","faces/7_of_diamonds.png","faces/7_of_hearts.png","faces/7_of_spades.png",
  "faces/8_of_clubs.png","faces/8_of_diamonds.png","faces/8_of_hearts.png","faces/8_of_spades.png",
  "faces/9_of_clubs.png","faces/9_of_diamonds.png","faces/9_of_hearts.png","faces/9_of_spades.png",
  "faces/ace_of_clubs.png","faces/ace_of_diamonds.png","faces/ace_of_hearts.png","faces/ace_of_spades2.png",
  "faces/jack_of_clubs2.png","faces/jack_of_diamonds2.png","faces/jack_of_hearts2.png","faces/jack_of_spades2.png",
  "faces/queen_of_clubs2.png","faces/queen_of_diamonds2.png","faces/queen_of_hearts2.png","faces/queen_of_spades2.png",
  "faces/king_of_clubs2.png","faces/king_of_diamonds2.png","faces/king_of_hearts2.png","faces/king_of_spades2.png"
];

let deck = [];
const usedReplaceSlots = new Set();
let busy = false;
let step = 0;

const wait = ms => new Promise(r => setTimeout(r, ms));
const flipWait = 600;

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

/* ====== Sound (WebAudio) ====== */
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === "suspended") audioCtx.resume();
}
function blip(freq=440, dur=0.06, type="sine", gain=0.06){
  if(!audioCtx) return;
  const t0 = audioCtx.currentTime;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.setValueAtTime(freq, t0);
  g.gain.setValueAtTime(0.0001, t0);
  g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
  o.connect(g).connect(audioCtx.destination);
  o.start(t0);
  o.stop(t0 + dur + 0.01);
}
function sfxFlip(){ blip(520, 0.07, "triangle", 0.05); blip(760, 0.05, "triangle", 0.03); }
function sfxMove(){ blip(220, 0.10, "sawtooth", 0.03); blip(330, 0.10, "sawtooth", 0.02); }
function sfxReplace(){ blip(900, 0.06, "square", 0.04); blip(420, 0.10, "sine", 0.03); }

/* ====== Deal / reset ====== */
function deal(){
  deck = shuffle(FACE_IMAGES);
  const faces = deck.splice(0,8);
  for(let i=1;i<=8;i++){
    document.getElementById("face"+i).src = faces[i-1];
  }
}
function reset(){
  document.querySelectorAll(".card").forEach(c => c.classList.remove("is-flipped"));
  document.getElementById("c1").classList.add("is-flipped");
}

/* ====== Replace rules (INVERTED) ======
   Slot is replaceable ONLY BEFORE card to the right is flipped:
     slot-1 => right is c2
     slot-a => right is c5
     slot-b => right is c8
*/
const RIGHT_CARD_BY_SLOT = {
  "slot-1": "c2",
  "slot-a": "c5",
  "slot-b": "c8"
};

function slotIdOfScene(scene){ return scene.parentElement.id; }

function rightCardIsFlipped(slot){
  const id = RIGHT_CARD_BY_SLOT[slot];
  const el = id ? document.getElementById(id) : null;
  return !!el && el.classList.contains("is-flipped");
}

function canReplace(scene){
  const slot = slotIdOfScene(scene);
  return (slot in RIGHT_CARD_BY_SLOT) &&
         !usedReplaceSlots.has(slot) &&
         deck.length > 0 &&
         !rightCardIsFlipped(slot) &&  // <-- BEFORE right card flips
         !busy;
}

function updateEligibilityUI(){
  // used slot outline
  document.querySelectorAll(".slot").forEach(sl => sl.classList.remove("used-discard"));
  usedReplaceSlots.forEach(id => document.getElementById(id)?.classList.add("used-discard"));

  // eligible glow
  document.querySelectorAll(".scene").forEach(scene => {
    scene.classList.toggle("eligible", canReplace(scene));
  });
}

async function replaceCard(scene){
  if(!canReplace(scene)) return false;

  const slot = slotIdOfScene(scene);
  usedReplaceSlots.add(slot);
  updateEligibilityUI();

  busy = true;
  ensureAudio();
  sfxReplace();

  const card = scene.querySelector(".card");
  const img  = scene.querySelector(".face.front img");

  scene.classList.add("moving");
  scene.style.transition = "transform 200ms ease, opacity 200ms ease";
  scene.style.transform  = "scale(0.6)";
  scene.style.opacity    = "0";
  await wait(200);

  img.src = deck.shift();
  card.classList.add("is-flipped"); // replacement appears face-up

  scene.style.transform = "";
  scene.style.opacity   = "1";
  await wait(200);

  scene.classList.remove("moving");
  scene.style.transition = "";
  busy = false;

  updateEligibilityUI();
  return true;
}

/* ====== Smooth move ====== */
async function moveSceneToSlotLift(sceneId, slotTargetId){
  busy = true;
  ensureAudio();
  sfxMove();

  const scene = document.getElementById(sceneId);
  const scenes = Array.from(document.querySelectorAll(".scene"));
  scenes.forEach(s => { s.style.transition=""; s.style.transform=""; });

  const liftPx = 18, liftDur = 180, moveDur = 650;

  scene.classList.add("moving");
  scene.style.transition = `transform ${liftDur}ms ease-out`;
  scene.style.transform  = `translateY(-${liftPx}px) scale(1.04)`;
  await wait(liftDur);

  const first = new Map();
  scenes.forEach(s => first.set(s.id, s.getBoundingClientRect()));

  document.getElementById(slotTargetId).appendChild(scene);

  const last = new Map();
  scenes.forEach(s => last.set(s.id, s.getBoundingClientRect()));

  scenes.forEach(s=>{
    const f = first.get(s.id), l = last.get(s.id);
    if(!f || !l) return;
    const dx = f.left - l.left;
    const dy = f.top  - l.top;
    if(dx || dy){
      s.style.transition="transform 0s";
      s.style.transform = (s===scene)
        ? `translate(${dx}px, ${dy}px) translateY(-${liftPx}px) scale(1.04)`
        : `translate(${dx}px, ${dy}px)`;
    }
  });

  void document.body.offsetHeight;

  scenes.forEach(s=>{
    if(!s.style.transform) return;
    s.style.transition = `transform ${moveDur}ms ease-in-out`;
    s.style.transform = (s===scene)
      ? `translateY(-${liftPx}px) scale(1.04)`
      : "";
  });

  await wait(moveDur);

  scene.style.transition = `transform ${liftDur}ms ease-in`;
  scene.style.transform  = "";
  await wait(liftDur);

  scenes.forEach(s=>{ s.style.transition=""; s.style.transform=""; });
  scene.classList.remove("moving");

  busy = false;
  updateEligibilityUI();
}

/* ====== Sequence ====== */
async function advance(){
  if(busy || step >= steps.length) return;
  busy = true;
  ensureAudio();
  await steps[step++]();
  busy = false;
  updateEligibilityUI();
}

const steps = [
  async ()=>{ document.getElementById("c2").classList.add("is-flipped"); sfxFlip(); await wait(flipWait); },
  async ()=>{ document.getElementById("c3").classList.add("is-flipped"); sfxFlip(); await wait(flipWait); },
  async ()=>{ document.getElementById("c4").classList.add("is-flipped"); sfxFlip(); await wait(flipWait); },
  async ()=>{ await moveSceneToSlotLift("s4","slot-a"); },
  async ()=>{ document.getElementById("c5").classList.add("is-flipped"); sfxFlip(); await wait(flipWait); },
  async ()=>{ document.getElementById("c6").classList.add("is-flipped"); sfxFlip(); await wait(flipWait); },
  async ()=>{ document.getElementById("c7").classList.add("is-flipped"); sfxFlip(); await wait(flipWait); },
  async ()=>{ await moveSceneToSlotLift("s7","slot-b"); },
  async ()=>{ document.getElementById("c8").classList.add("is-flipped"); sfxFlip(); await wait(flipWait); }
];

/* ====== INIT ====== */
deal();
reset();
updateEligibilityUI();

/* ====== Click behaviour ======
   - Click card: replace if eligible; otherwise advance
   - Click background: advance
*/
document.addEventListener("click", () => advance());

document.querySelectorAll(".scene").forEach(scene=>{
  scene.addEventListener("click", async (e)=>{
    e.stopPropagation();
    const didReplace = await replaceCard(scene);
    if(!didReplace) advance();
  });
});

document.addEventListener("keydown", (e)=>{
  if(e.code === "Space" || e.code === "Enter"){
    e.preventDefault();
    advance();
  }
});
</script>

</body>
</html>
